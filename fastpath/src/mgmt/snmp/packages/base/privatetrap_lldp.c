/*********************************************************************
*                                                                 
* *****  **   ***** **      Code classified LVL7 Confidential 
*
**********************************************************************
*
* Name: privatetrap_lldp.c
*
* Purpose: LLDP trap functions
*
* Created by: cpverne
*
* Component: SNMP
*
*********************************************************************/

#include "sr_conf.h"

#ifdef HAVE_STDIO_H
#include <stdio.h>
#endif /* HAVE_STDIO_H */
#ifdef HAVE_MEMORY_H
#include <memory.h>
#endif /* HAVE_MEMORY_H */
#include "sr_snmp.h"
#include "diag.h"
#include "sr_trans.h"
#include "context.h"
#include "method.h"
#include "mibout.h"
#include "getvar.h"
#include "sr_ntfy.h"

#include "l7_common.h"


/*********************************************************************
*
* @purpose  A notification generated by the local device sensing 
*           a change in the topology that indicates that a new remote 
*           device attached to a local port, or a remote device disconnected  
*           or moved from one port to another.
*
* @param    lldpRemChassisIdSubtype
* @param    lldpRemChassisId
* @param    lldpRemChassisId_len
* @param    lldpXMedRemDeviceClass
*
* @returns  L7_SUCCESS
* @returns  L7_FAILURE
*
* @notes    none
*
* @end
*********************************************************************/
L7_RC_t snmp_lldpXMedTopologyChangeDetectedTrapSend(L7_uint32 lldpRemChassisIdSubtype,
                                                    L7_uchar8 *lldpRemChassisId,
                                                    L7_uint32 lldpRemChassisId_len,
                                                    L7_uint32 lldpXMedRemDeviceClass)
{
  L7_uint32 status;
  OID *snmpTrapOID = MakeOIDFromDot("1.0.8802.1.1.2.1.5.4795.0.1");
  VarBind *temp_vb = NULL;

  OID *oid_lldpRemChassisIdSubtype = MakeOIDFromDot("lldpRemChassisIdSubtype.0");
  OID *oid_lldpRemChassisId = MakeOIDFromDot("lldpRemChassisId.0");
  OID *oid_lldpXMedRemDeviceClass = MakeOIDFromDot("1.0.8802.1.1.2.1.5.4795.1.3.1.1.3.0");
  OctetString *os_lldpRemChassisId = MakeOctetString(lldpRemChassisId, lldpRemChassisId_len);
  
  VarBind *var_lldpRemChassisIdSubtype = MakeVarBindWithValue(oid_lldpRemChassisIdSubtype, NULL, INTEGER_TYPE, &lldpRemChassisIdSubtype);
  VarBind *var_lldpRemChassisId = MakeVarBindWithValue(oid_lldpRemChassisId, NULL, OCTET_PRIM_TYPE, os_lldpRemChassisId);
  VarBind *var_lldpXMedRemDeviceClass = MakeVarBindWithValue(oid_lldpXMedRemDeviceClass, NULL, INTEGER_TYPE, &lldpXMedRemDeviceClass);

  FreeOID(oid_lldpRemChassisIdSubtype);
  FreeOID(oid_lldpRemChassisId);
  FreeOID(oid_lldpXMedRemDeviceClass);

  if (snmpTrapOID == NULL || var_lldpRemChassisIdSubtype == NULL || var_lldpRemChassisId == NULL || var_lldpXMedRemDeviceClass == NULL)
  {
    FreeOID(snmpTrapOID);
    
    FreeVarBind(var_lldpRemChassisIdSubtype);
    FreeVarBind(var_lldpRemChassisId);
    FreeVarBind(var_lldpXMedRemDeviceClass);
    return L7_FAILURE;
  }

  temp_vb = var_lldpRemChassisIdSubtype;
  var_lldpRemChassisIdSubtype->next_var = var_lldpRemChassisId;
  var_lldpRemChassisId->next_var = var_lldpXMedRemDeviceClass;
  var_lldpXMedRemDeviceClass->next_var = NULL;

  status = SendNotificationsSMIv2Params(snmpTrapOID, temp_vb, NULL);

  FreeOID(snmpTrapOID);
  FreeVarBindList(temp_vb);

  if (status == 0)
    return L7_SUCCESS;

  return L7_FAILURE;
}

