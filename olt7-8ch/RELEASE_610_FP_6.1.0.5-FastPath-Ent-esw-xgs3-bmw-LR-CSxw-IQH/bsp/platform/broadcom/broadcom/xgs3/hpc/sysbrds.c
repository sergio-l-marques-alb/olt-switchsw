/*
 * $Id: sysbrds.c,v 1.1 2011/04/18 17:10:19 mruas Exp $
 * $Copyright: (c) 2002, 2003 Broadcom Corp.
 * All Rights Reserved.$
 *
 * File:        sysbrds.c
 * Purpose:
 * Requires:
 */

/* Some basic board descriptions */
/* all of our chips support the LEDPROC */
#define BCM_LEDPROC_SUPPORT

#include <stdio.h>
#include <soc/drv.h>
#include <soc/cm.h>

#include <bcm/error.h>

#include "sysbrds.h"
#include "bcm/stack.h"
#include "registry.h"
#include <appl/stktask/topo_brd.h>

/*
 * Board specific initialization code
 * used by the board definitions below.
 */
#include "ledlink.h"
#include "l7_common.h"
#include "hpc_db.h"
#include <bcm/pkt.h>
#include <bcm/rx.h>
#include <bcm_int/esw/rcpu.h>
#include <bcm/l2.h>
#include "sysapi_hpc.h"
#include <sal/appl/config.h>

#include "soc/drv.h"
#include "broad_ids.h"


/* Default ID function */
int
bcm_sys_id_helix(const bcm_sys_board_t *brd)
{
    uint16 devid;

    if (soc_ndev != brd->num_units) {
        return FALSE;
    }

    soc_cm_get_id(0, &devid, NULL);

    /* Check if 302 is the chip */
    if(devid == 0xb302)
    {
      if (brd->dev_id[0] != devid)
        return FALSE;
      else
        return TRUE;
    }

    /* Check if 404, and 304 is the chip */
    if ((devid == 0xb304) || (devid ==0xb404) )
      return TRUE;

    return FALSE;
}

/* sdk56504ref.hex */
static const unsigned char ledproc_56504[] = {
0xE0,0x28,0x60,0xE3,0x67,0x4B,0x67,0x87,0x06,0xE3,0x80,0xD2,0x18,0x74,0x01,0x28,
0x60,0xE3,0x67,0xAF,0x75,0x1C,0x67,0xC4,0x67,0x4B,0x77,0x24,0x32,0x0E,0x87,0x32,
0x08,0x87,0x67,0xB6,0x06,0xE3,0x80,0xD2,0x1C,0x74,0x0F,0x12,0xE2,0x85,0x05,0xD2,
0x0F,0x71,0x35,0x52,0x00,0x12,0xE1,0x85,0x05,0xD2,0x1F,0x71,0x3F,0x52,0x00,0x12,
0xE0,0x85,0x05,0xD2,0x05,0x71,0x49,0x52,0x00,0x3A,0x70,0x32,0x00,0x97,0x75,0x57,
0x12,0xA0,0xFE,0xE3,0x02,0x0A,0x50,0x32,0x01,0x97,0x75,0x63,0x12,0xBC,0xFE,0xE3,
0x02,0x0A,0x50,0x12,0xBC,0xFE,0xE3,0x95,0x75,0x75,0x85,0x12,0xA0,0xFE,0xE3,0x95,
0x75,0xC4,0x85,0x77,0xB6,0x12,0xA0,0xFE,0xE3,0x95,0x75,0x7F,0x85,0x77,0xBD,0x16,
0xE0,0xDA,0x02,0x71,0xBD,0x77,0xC4,0x32,0x05,0x97,0x71,0x97,0x32,0x02,0x97,0x71,
0xB6,0x06,0xE1,0xD2,0x01,0x71,0xB6,0x06,0xE3,0x67,0xAF,0x75,0xB6,0x32,0x03,0x97,
0x71,0xC4,0x32,0x04,0x97,0x75,0xBD,0x06,0xE2,0xD2,0x07,0x71,0xBD,0x77,0xC4,0x12,
0x80,0xF8,0x15,0x1A,0x00,0x57,0x32,0x0E,0x87,0x32,0x0E,0x87,0x57,0x32,0x0E,0x87,
0x32,0x0F,0x87,0x57,0x32,0x0F,0x87,0x32,0x0E,0x87,0x57
};

/* poe48p56504.hex - for 48port FB/FB2 platforms */
static const unsigned char ledproc_56514_48[] = {
  0xE0, 0x28, 0x60, 0xE3, 0x67, 0x85, 0x67, 0x49, 0x06, 0xE3, 0x80, 0xD2, 0x18, 0x74, 0x01, 0x28, 
  0x60, 0xE3, 0x67, 0xAD, 0x75, 0x1A, 0x67, 0xC2, 0x77, 0x20, 0x32, 0x0E, 0x87, 0x32, 0x08, 0x87, 
  0x67, 0x49, 0x06, 0xE3, 0x80, 0xD2, 0x1A, 0x74, 0x0F, 0x12, 0xE2, 0x85, 0x05, 0xD2, 0x0F, 0x71,
  0x33, 0x52, 0x00, 0x12, 0xE1, 0x85, 0x05, 0xD2, 0x1F, 0x71, 0x3D, 0x52, 0x00, 0x12, 0xE0, 0x85,
  0x05, 0xD2, 0x05, 0x71, 0x47, 0x52, 0x00, 0x3A, 0x68, 0x32, 0x00, 0x97, 0x75, 0x55, 0x12, 0xA0,
  0xFE, 0xE3, 0x02, 0x0A, 0x50, 0x32, 0x01, 0x97, 0x75, 0x61, 0x12, 0xBA, 0xFE, 0xE3, 0x02, 0x0A,
  0x50, 0x12, 0xBA, 0xFE, 0xE3, 0x95, 0x75, 0x73, 0x85, 0x12, 0xA0, 0xFE, 0xE3, 0x95, 0x75, 0xC2,
  0x85, 0x77, 0xB4, 0x12, 0xA0, 0xFE, 0xE3, 0x95, 0x75, 0x7D, 0x85, 0x77, 0xBB, 0x16, 0xE0, 0xDA,
  0x02, 0x71, 0xBB, 0x77, 0xC2, 0x32, 0x05, 0x97, 0x71, 0x95, 0x32, 0x02, 0x97, 0x71, 0xB4, 0x06,
  0xE1, 0xD2, 0x01, 0x71, 0xB4, 0x06, 0xE3, 0x67, 0xAD, 0x75, 0xB4, 0x32, 0x03, 0x97, 0x71, 0xC2,
  0x32, 0x04, 0x97, 0x75, 0xBB, 0x06, 0xE2, 0xD2, 0x07, 0x71, 0xBB, 0x77, 0xC2, 0x12, 0x80, 0xF8,
  0x15, 0x1A, 0x00, 0x57, 0x32, 0x0E, 0x87, 0x32, 0x0E, 0x87, 0x57, 0x32, 0x0E, 0x87, 0x32, 0x0F,
  0x87, 0x57, 0x32, 0x0F, 0x87, 0x32, 0x0E, 0x87, 0x57
};

int
bcm_sys_sa_init_56304(const bcm_sys_board_t* brd, int base)
{

    /* Set the modids for local units */
    BCM_IF_ERROR_RETURN(bcm_stk_my_modid_set(0, 0));

    soc_ledproc_config(0, ledproc_56504, sizeof(ledproc_56504));
    bcm_linkscan_register(0, hpc_default_led_linkscan_cb);

    return 0;
}

int
bcm_sys_sa_init_56504(const bcm_sys_board_t* brd, int base)
{
    L7_uint32 cpuCardType;

    sysapiRegistryGet(CPU_CARDID, U32_ENTRY, &cpuCardType);

    if ((brd->sys_brd_id == BCM_SYS_BOARD_56514_P48) ||
        (brd->sys_brd_id == BCM_SYS_BOARD_56504_P48))
    {
       bcm_linkscan_register(0, hpc_default_led_linkscan_cb);
       bcm_linkscan_register(1, hpc_default_led_linkscan_cb);

       /* Broadcom SDK */
       soc_ledproc_config(0, ledproc_56514_48, sizeof(ledproc_56514_48));
       soc_ledproc_config(1, ledproc_56514_48, sizeof(ledproc_56514_48));

       /* Enable the Higig links connecting the FB-2 chips. */
       bcm_port_enable_set(0,26,1);  /* 2 ports on unit 0 */
       bcm_port_enable_set(0,27,1);
       bcm_port_enable_set(1,26,1);  /* 2 ports on unit 1 */
       bcm_port_enable_set(1,27,1);
       return 0;
    }
    else 
    {
       soc_ledproc_config(0, ledproc_56504, sizeof(ledproc_56504));
    }

    bcm_linkscan_register(0, hpc_default_led_linkscan_cb);

    return 0;
}

/* sdk56800 */
static const unsigned char ledproc_56800[] = {
 0xE0, 0x28, 0x60, 0xF2, 0x67, 0x1B, 0x06, 0xF2,
 0x80, 0xD2, 0x14, 0x74, 0x01, 0x86, 0xF3, 0x12,
 0xF0, 0x85, 0x05, 0xD2, 0x05, 0x71, 0x19, 0x52,
 0x00, 0x3A, 0x28, 0x32, 0x00, 0x97, 0x75, 0x27,
 0x12, 0xA8, 0xFE, 0xF2, 0x02, 0x0A, 0x50, 0x32,
 0x01, 0x97, 0x75, 0x33, 0x12, 0xBC, 0xFE, 0xF2,
 0x02, 0x0A, 0x50, 0x12, 0xBC, 0xFE, 0xF2, 0x95,
 0x75, 0x45, 0x85, 0x12, 0xA8, 0xFE, 0xF2, 0x95,
 0x75, 0x91, 0x85, 0x77, 0x57, 0x12, 0xA8, 0xFE,
 0xF2, 0x95, 0x75, 0x4F, 0x85, 0x77, 0x8A, 0x16,
 0xF0, 0xDA, 0x02, 0x71, 0x8A, 0x77, 0x91, 0x06,
 0xF2, 0x12, 0x94, 0xF8, 0x15, 0x02, 0x02, 0xC1,
 0x74, 0x6E, 0x02, 0x04, 0xC1, 0x74, 0x6E, 0x02,
 0x08, 0xC1, 0x74, 0x6E, 0x77, 0x74, 0xC6, 0xF3,
 0x74, 0x91, 0x77, 0x8A, 0x06, 0xF2, 0x67, 0x7C,
 0x75, 0x83, 0x77, 0x91, 0x12, 0x80, 0xF8, 0x15,
 0x1A, 0x00, 0x57, 0x32, 0x0E, 0x87, 0x32, 0x0E,
 0x87, 0x57, 0x32, 0x0E, 0x87, 0x32, 0x0F, 0x87,
 0x57, 0x32, 0x0F, 0x87, 0x32, 0x0E, 0x87, 0x57,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

int
bcm_sys_sa_init_56800(const bcm_sys_board_t* brd, int base)
{

    /* Program led processor */
    soc_ledproc_config(0, ledproc_56800, sizeof(ledproc_56800));

    bcm_linkscan_register(0, hpc_default_led_linkscan_cb);

    return 0;
}

/*********************************************************************
* @purpose  Board specific driver configuration.
*
* @param    
*                                       
* @returns  L7_SUCCESS 
* @returns  L7_FAILURE 
*
* @end
*********************************************************************/
L7_RC_t hpcConfigBoardSet()
{
  HPC_UNIT_DESCRIPTOR_t       *lclUnitDesc;

  if ((lclUnitDesc = hpcLocalUnitDescriptorGet()) != L7_NULLPTR)
  {
    switch (lclUnitDesc->unitTypeDescriptor.unitTypeId)
    {

      case UNIT_BROAD_24_GIG_4_TENGIG_56304_REV_1_ID:
        /* HELIX only */
        if (sal_config_set(spn_MMU_STATIC_BYTES,"1536") != 0)
          return (L7_FAILURE);
        if (sal_config_set(spn_MMU_OVERCOMMIT,"6") != 0)
          return (L7_FAILURE);
        if (sal_config_set(spn_MMU_OVERCOMMIT_STACK,"12") != 0)
          return (L7_FAILURE);
        if (sal_config_set(spn_MMU_FLOW_PERCENT,"50") != 0)
          return (L7_FAILURE);
        if (sal_config_set(spn_MMU_FLOW_FANIN,"4") != 0)
          return (L7_FAILURE);
        /* ENDS HELIX only */

      case UNIT_BROAD_24_GIG_4_TENGIG_56504_REV_1_ID:
      case UNIT_BROAD_48_GIG_4_TENGIG_56504_REV_1_ID:
      case UNIT_BROAD_20_TENGIG_56800_REV_1_ID:
      case UNIT_BROAD_16_GIG_4_TENGIG_56580_REV_1_ID:
        if (sal_config_set(spn_TRUNK_EXTEND, "0x1") != 0)
          return(L7_FAILURE);
        break;
      case UNIT_BROAD_24_GIG_4_TENGIG_56514_REV_1_ID:
      case UNIT_BROAD_48_GIG_4_TENGIG_56514_REV_1_ID:
        /* Enable trunk_128 bit. This will enable 128 trunks */
        /* and fixes LAG issue on XGS3 stacking              */
        if (sal_config_set(spn_TRUNK_EXTEND, "0x1") != 0)
          return(L7_FAILURE);
#ifdef L7_STACKING_PACKAGE
        /* On Stacking packages, restrict FDB size to 16K MAX for FB2. */
        if (sal_config_set("l2_table_size", "0x3fff") != 0)
          return(L7_FAILURE);
#endif
        break;
  
      default:
        break;
    }
  }

  return(L7_SUCCESS);
}
/*********************************************************************
* @purpose  Board specific PHY configuration
*
* @param    
*                                       
* @returns  L7_SUCCESS 
* @returns  L7_FAILURE 
*
* @comments these ports are referred to as XPORTS
*       
* @end
*********************************************************************/
L7_RC_t hpcConfigBoardPhySet(int       portNo,
                             L7_uint32 cardTypeId,
                             HAPI_CARD_SLOT_MAP_t *hapiSlotMapPtr)
{
  return L7_SUCCESS;
}

/*********************************************************************
* @purpose  Board specific POST PHY configuration
*
* @param
*
* @returns  L7_SUCCESS
* @returns  L7_FAILURE
*
* @comments these ports are referred to as XPORTS
*
* @end
*********************************************************************/
L7_RC_t hpcConfigBoardPhyPostSet(int       portNo,
                             L7_uint32 cardTypeId,
                             HAPI_CARD_SLOT_MAP_t *hapiSlotMapPtr,
                             L7_uint32 phyCap)
{
  return L7_SUCCESS;
}

