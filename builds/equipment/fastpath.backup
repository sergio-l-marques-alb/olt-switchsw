startup()
{
    echo "FASTPATH STARTED AT: `date` [retry $ntry]" >> $startup_log
    cat $proc_txt >> $startup_log
    free >> $startup_log
    exec 1>>$startup_log 2>&1
    sb 1000f080h ffh
    nice -n -19 $app_path 0>/dev/null &
    sleep 120
    exec 1>&- 2>&-
    let "ntry=ntry+1"
}

mode="run"
app_name=switchdrvr
app_path=/usr/local/ptin/sbin/$app_name
startup_log=/usr/local/ptin/log/fastpath/startup.log
proc_txt=/usr/local/ptin/log/fastpath/proc.txt
nproc=0
nproc2=0
ntry=0

if [ ! -z $1 ]; then
    mode=$1
fi

if [ $mode = "stop" ]; then
    # Kill fastpath script process
    ps > proc.tmp
    pid_proc=`cat proc.tmp | grep 'fastpath boot' | awk '{print $1}'`
    if [ ! -z $pid_proc ]; then
        kill $pid_proc
    fi
    rm proc.tmp;
    # Now, kill the switchdrvr application
    killall $app_name

elif [ $mode = "boot" ]; then
    rm $startup_log > /dev/null 2>&1
    #sleep 120
    while [ 1 ]
    do
        ps > $proc_txt
        nproc=$(cat $proc_txt | grep -c $app_name)
        if [ $nproc = 0 ]; then
            startup;
        else
            sleep 60
        fi
    done
else
    ps > $proc_txt
    nproc=$(cat $proc_txt | grep -c $app_name)
    nproc2=$(cat $proc_txt | grep -c 'fastpath boot')
    if [ $nproc != 0 ]; then
        echo "$app_name is already running! ($nproc)"
    elif [ $nproc2 != 0 ]; then
        echo "There is already an anjel responsible to startup $app_name ($nproc2)"
    else
	sync
        sb 1000f080h ffh
        nice -n -19 $app_path 0>/dev/null &
    fi
fi
