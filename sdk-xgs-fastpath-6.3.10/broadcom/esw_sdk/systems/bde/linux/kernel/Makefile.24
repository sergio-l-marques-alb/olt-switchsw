FP_BASE=../../../../../../..

KERNLIB=kern_kbde.a

# Linux Kernel module kbde.o Makefile
#
#

# Do not change this line.
#
include $(FP_BASE)/src/l7tools/build/make.cfg

# Specify additional header directories needed by your component

COMPONENT_INCLDIR += $(BROADCOM_INCL) \
        -I$(BROADCOM_SRC)/../systems/bde/linux/include \
        -I$(BROADCOM_SRC)/../systems/bde/linux/user/kernel \
        -I$(BROADCOM_SRC)/../systems/linux/kernel/modules/include 

COMPONENT_INCLDIR += \
        -I$(KERNEL_SRC)/include \
        -I../include

# Specify compile flags.
#
CFLAGSLOCAL= $(GFLAG) -D__KERNEL__ -O2 -Werror
ifeq ($(L7_CPU),raptor)
CFLAGSLOCAL+=-Wall -Wstrict-prototypes -Wno-trigraphs -O2 -fno-strict-aliasing -fno-common -fomit-frame-pointer -G 0 -mno-abicalls -fno-pic -pipe -mtune=r4600 -mips2 -Wa,--trap -mlong-calls
endif

# Specify modules that need to be compiled.
#
LIBOBJS = linux-kernel-bde.o mpool.o

KERNEL_LIBS = ../../../linux/kernel/modules/shared/kern_mod_shared.a

bldlib: kbde.kmod
	$(STRIP) -g kbde.kmod -o $(FP_BASE)/bsp/cpu/$(L7_CPU)/$(L7_TARGETOS)/target/kbde.o 
	rm -f *.o

kbde.kmod: $(KERNLIB)($(LIBOBJS)) $(KERNEL_LIBS)
	rm -f kbde.kmod
	$(MAKE) -f Makefile.24 $(LIBOBJS)
	$(linkcmd) -o kbde.kmod -Map kbde.map -r $(LIBOBJS) $(KERNEL_LIBS)

mpool.c: ../shared/mpool.c
	rm -f mpool.c
	cp ../shared/mpool.c .

clean::
	-$(RM) mpool.c
	-$(RM) *.o
	-$(RM) *.map
	-$(RM) *.kmod
	-$(RM) $(KERNLIB)

(%.o) : %.c
	$(CC) -Wp,-MD,$(*F).d $(CFLAGS) $(CFLAGSLOCAL) -c $<
	$(AR) r $@ $*.o

# Do not change this line.
#
include $(FP_BASE)/src/l7tools/build/make.footer
